<script>
const homeInput=document.getElementById("homeInput");
const chatInput=document.getElementById("chatInput");
const messages=document.getElementById("messages");

let chatHistory = [];

homeInput.focus();

homeInput.addEventListener("keydown",e=>{
 if(e.key==="Enter" && homeInput.value.trim()){
   openChat(homeInput.value);
 }
});

chatInput.addEventListener("keydown",e=>{
 if(e.key==="Enter" && chatInput.value.trim()){
   send(chatInput.value);
 }
});

function openChat(text){
 document.getElementById("home").style.display="none";
 document.getElementById("chat").style.display="flex";
 send(text);
}

function goHome(){
 document.getElementById("home").style.display="block";
 document.getElementById("chat").style.display="none";
 document.getElementById("tcPage").style.display="none";
 messages.innerHTML="";
 chatHistory=[];   // reset memory
 homeInput.focus();
}

function openTC(){
 document.getElementById("home").style.display="none";
 document.getElementById("tcPage").style.display="block";
}

function addMessage(text,type){
 const div=document.createElement("div");
 div.className="msg "+type;
 div.textContent=text;
 messages.appendChild(div);
 messages.scrollTop=messages.scrollHeight;
}

async function send(text){

 addMessage(text,"user");
 chatInput.value="";

 // store user message
 chatHistory.push({ role:"user", content:text });

 try{
  const res=await fetch("/api/speak",{
   method:"POST",
   headers:{"Content-Type":"application/json"},
   body:JSON.stringify({ messages: chatHistory })
  });

  const data=await res.json();

  addMessage(data.reply,"bot");

  // store AI reply
  chatHistory.push({ role:"assistant", content:data.reply });

 }catch{
  addMessage("Connection issue. Try again.","bot");
 }
}
</script>
